

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="OnikataHoshio">
  <meta name="keywords" content="">
  
    <meta name="description" content="前言 前两篇文章介绍了虚幻引擎中计算管线和图形管线的调用流程，但示例中仅在某个 Actor 的 BeginPlay() 中调用了一次。如果希望在每一帧都执行这个自定义管线，又该如何实现呢？ 这时就需要借助 SceneViewExtension。SceneViewExtension 为我们提供了渲染流程中多个阶段的 Hook，既涵盖游戏线程，也包含渲染线程。通过重载对应的虚函数，我们可以实现例如：">
<meta property="og:type" content="article">
<meta property="og:title" content="虚幻引擎用SceneViewExtension实现简单后处理效果">
<meta property="og:url" content="https://onikatahoshio.github.io/2026/Unreal/RDG%E6%B8%B2%E6%9F%93%E4%BE%9D%E8%B5%96%E5%9B%BE/03-%E7%94%A8SceneViewExtension%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E5%90%8E%E5%A4%84%E7%90%86%E6%95%88%E6%9E%9C/index.html">
<meta property="og:site_name" content="星生的小窝">
<meta property="og:description" content="前言 前两篇文章介绍了虚幻引擎中计算管线和图形管线的调用流程，但示例中仅在某个 Actor 的 BeginPlay() 中调用了一次。如果希望在每一帧都执行这个自定义管线，又该如何实现呢？ 这时就需要借助 SceneViewExtension。SceneViewExtension 为我们提供了渲染流程中多个阶段的 Hook，既涵盖游戏线程，也包含渲染线程。通过重载对应的虚函数，我们可以实现例如：">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://onikatahoshio.github.io/img/LearnSVE.png">
<meta property="article:published_time" content="2026-01-31T12:00:00.000Z">
<meta property="article:modified_time" content="2026-02-17T12:01:23.650Z">
<meta property="article:author" content="OnikataHoshio">
<meta property="article:tag" content="RDG">
<meta property="article:tag" content="SceneViewExtension">
<meta property="article:tag" content="渲染依赖图">
<meta property="article:tag" content="虚幻引擎">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://onikatahoshio.github.io/img/LearnSVE.png">
  
  
  
  <title>虚幻引擎用SceneViewExtension实现简单后处理效果 - 星生的小窝</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"onikatahoshio.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 8.1.1"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>星生的小窝</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="虚幻引擎用SceneViewExtension实现简单后处理效果"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2026-01-31 20:00" pubdate>
          2026年1月31日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          3.9k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          33 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">虚幻引擎用SceneViewExtension实现简单后处理效果</h1>
            
            
              <div class="markdown-body">
                
                <h3 id="前言">前言</h3>
<p>前两篇文章介绍了虚幻引擎中计算管线和图形管线的调用流程，但示例中仅在某个
<code>Actor</code> 的 <code>BeginPlay()</code>
中调用了一次。如果希望<strong>在每一帧都执行这个自定义管线</strong>，又该如何实现呢？</p>
<p>这时就需要借助
<code>SceneViewExtension</code>。<code>SceneViewExtension</code>
为我们提供了渲染流程中多个阶段的
Hook，既涵盖<strong>游戏线程</strong>，也包含<strong>渲染线程</strong>。通过重载对应的虚函数，我们可以实现例如：</p>
<ol type="1">
<li>修改视口（View）的相关属性；</li>
<li>获取RDG中的相关资源，例如<code>GBuffer</code>、<code>SceneColor</code>等;</li>
<li>注入并执行自定义着色器；</li>
</ol>
<p>然而，正如其名字所暗示的那样，<code>SceneViewExtension</code>
本质上只是一个“扩展点”，它并不会改变 Unreal Engine
内部真正的光照模型。即使我们在某个 Hook 中基于 GBuffer
重新计算了一套完整的光照结果，也只是<strong>在现有渲染结果之上额外进行了一次计算</strong>，并不会影响引擎内部的光照流程本身。<br />
如果希望真正替换或重写光照模型，就必须修改 Unreal Engine
的渲染源码。相比之下，这一点确实要比 URP 麻烦不少。</p>
<p>在理解了这一限制之后，<code>SceneViewExtension</code>
更适合用于一些<strong>非侵入式的渲染扩展</strong>。因此，本文将介绍如何利用
<code>SceneViewExtension</code>
实现一个简单的后处理效果——一个“丐版”的复古电视机滤镜。本文使用的虚幻引擎版本仍然是
<strong>5.7</strong>。</p>
<p>代码参考了Github上的一个模板：<a
target="_blank" rel="noopener" href="https://github.com/A57R4L/SceneViewExtensionTemplate">SceneViewExtensionTemplate</a></p>
<p>本项目的源码：<a
target="_blank" rel="noopener" href="https://github.com/OnikataHoshio/LearnRDG">OnikataHoshio/LearnRDG</a></p>
<h3 id="配置sve插件">配置SVE插件</h3>
<h4 id="配置虚拟路径映射">配置虚拟路径映射</h4>
<p>打开虚幻引擎，依次点击 <strong>编辑 → 插件 →
添加</strong>，创建一个新的插件，这里将其命名为
<strong>RetroTV</strong>。<br />
创建完成后，插件结构如下图所示： <img src="/2026/Unreal/RDG%E6%B8%B2%E6%9F%93%E4%BE%9D%E8%B5%96%E5%9B%BE/03-%E7%94%A8SceneViewExtension%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E5%90%8E%E5%A4%84%E7%90%86%E6%95%88%E6%9E%9C/IMG-20260131211504097.png" srcset="/img/loading.gif" lazyload class=""> 随后打开生成的
<strong>C++ 项目</strong>，在 <code>RetroTV.cpp</code> 中为插件添加
<code>Shaders</code> 目录的<strong>虚拟路径映射</strong>。
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FRetroTVModule::StartupModule</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-comment">// This code will execute after your module is loaded into memory; the exact timing is specified in the .uplugin file per-module</span><br>	FString PluginShaderDir = FPaths::<span class="hljs-built_in">Combine</span>(FPaths::<span class="hljs-built_in">ProjectPluginsDir</span>(), <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;/RetroTV/Shaders&quot;</span>));<br>	<span class="hljs-built_in">AddShaderSourceDirectoryMapping</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;/Plugins/RetroTVShaders&quot;</span>), PluginShaderDir);<br>&#125;<br></code></pre></td></tr></table></figure> 通过这一步配置，我们就可以将所有与该插件相关的
<code>.usf</code> 着色器文件，直接放在插件目录下的 <code>Shaders</code>
文件夹中，而不需要放入引擎或项目的全局 Shader 目录。最终的目录结构如下:
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp">LearnRDG<br>	|-Content<br>	|-Plugins<br>		|-RetroTV<br>			|-Shaders<br>			|-Source<br></code></pre></td></tr></table></figure></p>
<h4 id="配置模块依赖">配置模块依赖</h4>
<p>接下来需要在 <code>RetroTV.Build.cs</code>
中配置插件所需的模块依赖与路径依赖。<br />
其中，自定义着色器和 RDG 功能依赖于
<code>RenderCore</code>、<code>Renderer</code> 以及 <code>RHI</code>
模块；<code>Projects</code> 模块用于配置 Shader 的虚拟路径映射；而
<code>DeveloperSettings</code>
则用于辅助我们读取和引用部分配置或资源。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs cpp">var EngineDir = Path.<span class="hljs-built_in">GetFullPath</span>(Target.RelativeEnginePath);<br><br>PrivateIncludePaths.<span class="hljs-built_in">AddRange</span>(<br>	<span class="hljs-keyword">new</span> string[] &#123;<br>		<span class="hljs-comment">// ... add other private include paths required here ...</span><br>		<span class="hljs-comment">// Required to find PostProcessing includes f.ex. screenpass.h &amp; TranslucentPassResource.h</span><br>		Path.<span class="hljs-built_in">Combine</span>(EngineDir, <span class="hljs-string">&quot;Source/Runtime/Renderer/Private&quot;</span>),<br>		Path.<span class="hljs-built_in">Combine</span>(EngineDir, <span class="hljs-string">&quot;Source/Runtime/Renderer/Internal&quot;</span>)<br>	&#125;<br>);<br>		<br>PrivateDependencyModuleNames.<span class="hljs-built_in">AddRange</span>(<br>	<span class="hljs-keyword">new</span> string[]<br>	&#123;<br>		<span class="hljs-string">&quot;CoreUObject&quot;</span>,<br>		<span class="hljs-string">&quot;Engine&quot;</span>,<br>		<span class="hljs-string">&quot;Slate&quot;</span>,<br>		<span class="hljs-string">&quot;SlateCore&quot;</span>,<br>		<span class="hljs-comment">// ... add private dependencies that you statically link with here ...	</span><br>		<span class="hljs-string">&quot;RenderCore&quot;</span>,<br>		<span class="hljs-string">&quot;Renderer&quot;</span>,<br>		<span class="hljs-string">&quot;RHI&quot;</span>,<br>		<span class="hljs-string">&quot;Projects&quot;</span>,<br>		<span class="hljs-string">&quot;DeveloperSettings&quot;</span><br>	&#125;<br>	);<br></code></pre></td></tr></table></figure>
<h4 id="修改retrotv.uplugin">修改RetroTV.uplugin</h4>
<p>打开<code>RetroTV.uplugin</code>，将<code>Modules</code> 中的
<code>LoadingPhase</code> 从 <code>Default</code> 修改为
<code>PostConfigInit</code>，否则可能会出现 <strong>Shader
在虚拟路径尚未建立之前就被编译</strong>
的问题，从而导致编译失败或路径无法解析。 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs javaScript"><span class="hljs-string">&quot;Modules&quot;</span>: [<br>	&#123;<br>		<span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;RetroTV&quot;</span>,<br>		<span class="hljs-string">&quot;Type&quot;</span>: <span class="hljs-string">&quot;Runtime&quot;</span>,<br>		<span class="hljs-string">&quot;LoadingPhase&quot;</span>: <span class="hljs-string">&quot;PostConfigInit&quot;</span><br>	&#125;<br></code></pre></td></tr></table></figure></p>
<h3 id="编写usf文件">编写usf文件</h3>
<p>我希望实现一个“丐版”的复古电视风格效果，整体可以拆分为以下四个主要环节：</p>
<ol type="1">
<li>镜头畸变；</li>
<li>电视机蒙版；</li>
<li>噪点；</li>
<li>扫描线。</li>
</ol>
<p>除此之外，还可以进一步加入诸如高斯模糊、UV
突变等效果。不过考虑到这只是一个用于练手和验证流程的小工程，本文中不会将实现设计得过于复杂。</p>
<p>此外，由于如何编写usf文件不是本篇文章的重点，因此直接给出相关代码：
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// Custom CS PostProcessing Shader</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;/Engine/Public/Platform.ush&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;/Engine/Private/Common.ush&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;/Engine/Private/ScreenPass.ush&quot;</span></span><br><br>Texture2D OriginalSceneColor;<br>Texture2D TVMaskTexture;<br>Texture2D ScanLineTexture;<br><br><span class="hljs-type">float</span> RetroScaleFactor;<br><span class="hljs-type">float</span> LensDistortionK1; <br><span class="hljs-type">float</span> LensDistortionK2; <br><br><span class="hljs-type">float</span> VignetteStart;  <br><span class="hljs-type">float</span> VignetteEnd; <br><span class="hljs-type">float</span> VignettePower;   <br><span class="hljs-type">float</span> VignetteIntensity;  <br><br><span class="hljs-type">float</span> ScanlineSpeed;<br><span class="hljs-type">float</span> ScanlineIntensity;<br><span class="hljs-type">float</span> ScanlineScale;<br><br><span class="hljs-built_in">SCREEN_PASS_TEXTURE_VIEWPORT</span>(SceneColorViewport)<br><br>RWTexture2D&lt;float4&gt; Output;<br><br><span class="hljs-function"><span class="hljs-type">float</span> <span class="hljs-title">CalcaulateLuminance</span><span class="hljs-params">(float3 color)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">dot</span>(color, <span class="hljs-built_in">float3</span>(<span class="hljs-number">0.2126f</span>, <span class="hljs-number">0.7152f</span>, <span class="hljs-number">0.0722f</span>));<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">float</span> <span class="hljs-title">GetNoise</span><span class="hljs-params">(float2 p, <span class="hljs-type">float</span> offset)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">frac</span>(<span class="hljs-built_in">sin</span>(<span class="hljs-built_in">dot</span>(p + offset, <span class="hljs-built_in">float2</span>(<span class="hljs-number">12.9898</span>, <span class="hljs-number">78.233</span>))) * <span class="hljs-number">43758.5453</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">float</span> <span class="hljs-title">HDRToLDR</span><span class="hljs-params">(float3 color)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">float</span> luma = <span class="hljs-built_in">CalcaulateLuminance</span>(color);<br>    <span class="hljs-keyword">return</span> luma / (<span class="hljs-number">1.0f</span> + luma); <br>&#125;<br><br><span class="hljs-function">float4 <span class="hljs-title">CalculateColorGrain</span><span class="hljs-params">(float3 hdrColor, float2 uv)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">float</span> lumaLDR = <span class="hljs-built_in">HDRToLDR</span>(hdrColor);<br>    <br>    float2 seed = uv + View.StateFrameIndexMod8; <br>    <br>    float3 noise;<br>    noise.r = <span class="hljs-built_in">GetNoise</span>(seed , <span class="hljs-number">0.1337</span>);       <br>    noise.g = <span class="hljs-built_in">GetNoise</span>(seed , <span class="hljs-number">0.4242</span>);    <br>    noise.b = <span class="hljs-built_in">GetNoise</span>(seed , <span class="hljs-number">0.5342</span>);   <br><br>    <span class="hljs-type">float</span> strength = <span class="hljs-number">1.0</span> - <span class="hljs-built_in">pow</span>(<span class="hljs-built_in">abs</span>(lumaLDR - <span class="hljs-number">0.5</span>) * <span class="hljs-number">2.0</span>, <span class="hljs-number">2.0</span>);<br><br>    float3 grain = (noise - <span class="hljs-number">0.5f</span>) * strength * lumaLDR; <br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">float4</span>(grain, <span class="hljs-number">1.0f</span>);<br>&#125;<br><br><span class="hljs-function">float2 <span class="hljs-title">CalculateDistortedUV</span><span class="hljs-params">(float2 screenCoord, <span class="hljs-type">float</span> viewAspect)</span></span><br><span class="hljs-function"></span>&#123;<br>    float2 p = screenCoord;<br>    p.x *= viewAspect;<br><br>    <span class="hljs-type">float</span> r2 = <span class="hljs-built_in">dot</span>(p, p);<br>    <span class="hljs-type">float</span> scale = <span class="hljs-number">1.0f</span> + LensDistortionK1 * r2 + LensDistortionK2 * (r2 * r2);<br>    float2 distortedP = p * scale;<br>    distortedP.x /= viewAspect;<br><br>    float2 distortedUV = (distortedP + <span class="hljs-number">1.0f</span>) * <span class="hljs-number">0.5f</span>;<br>    <span class="hljs-keyword">return</span> distortedUV;<br>&#125;<br><br><span class="hljs-function">float4 <span class="hljs-title">CalculateDistortedColor</span><span class="hljs-params">(float2 distortedUV, <span class="hljs-type">float</span> viewAspect)</span></span><br><span class="hljs-function"></span>&#123;<br>    float2 uvMin = <span class="hljs-built_in">float2</span>(SceneColorViewport_ViewportMin) * SceneColorViewport_ExtentInverse + SceneColorViewport_ExtentInverse;<br>    float2 uvMax = <span class="hljs-built_in">float2</span>(SceneColorViewport_ViewportMin + SceneColorViewport_ViewportSize) * SceneColorViewport_ExtentInverse - SceneColorViewport_ExtentInverse;<br><br>    <span class="hljs-type">bool</span> outside = <span class="hljs-built_in">any</span>(distortedUV &lt; uvMin) || <span class="hljs-built_in">any</span>(distortedUV &gt; uvMax);<br><br>    float2 safeUV = <span class="hljs-built_in">clamp</span>(distortedUV, uvMin, uvMax);<br>    float4 distortedColor = OriginalSceneColor.<span class="hljs-built_in">SampleLevel</span>(GlobalBilinearClampedSampler, safeUV, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (outside) distortedColor = <span class="hljs-built_in">float4</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">return</span> distortedColor;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">float</span> <span class="hljs-title">CalculateVignette</span><span class="hljs-params">(float2 distortedUV)</span></span><br><span class="hljs-function"></span>&#123;<br>    float2 centeredUV = distortedUV * <span class="hljs-number">2.0f</span> - <span class="hljs-number">1.0f</span>;<br>    <span class="hljs-type">float</span> dist = <span class="hljs-built_in">length</span>(centeredUV);<br><br>    <span class="hljs-type">float</span> vignette = <span class="hljs-built_in">smoothstep</span>(VignetteStart, VignetteEnd, dist);<br>    vignette = <span class="hljs-built_in">pow</span>(<span class="hljs-number">1.0</span> - vignette, VignettePower);<br>    vignette = <span class="hljs-built_in">lerp</span>(<span class="hljs-number">1.0f</span>, vignette, VignetteIntensity);<br>    <br>    <span class="hljs-keyword">return</span> vignette;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">float</span> <span class="hljs-title">CalculateScanline</span><span class="hljs-params">(float2 uv)</span></span><br><span class="hljs-function"></span>&#123;<br>    uv *= ScanlineScale;<br><br>    uv.y += View.RealTime * ScanlineSpeed;<br><br>    <span class="hljs-type">float</span> scanline = ScanLineTexture.<span class="hljs-built_in">SampleLevel</span>(GlobalBilinearWrappedSampler,uv,<span class="hljs-number">0</span>).r;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1.0f</span> - scanline * ScanlineIntensity;<br>&#125;<br><br><br>[<span class="hljs-built_in">numthreads</span>(<span class="hljs-number">8</span>, <span class="hljs-number">8</span>, <span class="hljs-number">1</span>)]<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">MainCS</span><span class="hljs-params">(uint2 DispatchThreadId : SV_DispatchThreadID)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">any</span>(DispatchThreadId &gt;= SceneColorViewport_ViewportSize)) <span class="hljs-keyword">return</span>;<br><br>    float2 sampleUV = (<span class="hljs-built_in">float2</span>(SceneColorViewport_ViewportMin) + (<span class="hljs-built_in">float2</span>(DispatchThreadId) + <span class="hljs-number">0.5f</span>)) * SceneColorViewport_ExtentInverse;<br>    float2 screenCoord = sampleUV * <span class="hljs-number">2.0f</span> - <span class="hljs-number">1.0f</span>;<br>    screenCoord *= RetroScaleFactor;<br><br>    <span class="hljs-type">float</span> viewAspect = (<span class="hljs-type">float</span>)SceneColorViewport_ViewportSize.x / (<span class="hljs-type">float</span>)SceneColorViewport_ViewportSize.y;<br>    <br>    float2 distortedUV = <span class="hljs-built_in">CalculateDistortedUV</span>(screenCoord, viewAspect);<br><br>    float4 distortedColor = <span class="hljs-built_in">CalculateDistortedColor</span>(distortedUV, viewAspect);<br>    <span class="hljs-type">float</span> luminance = <span class="hljs-built_in">CalcaulateLuminance</span>(distortedColor.rgb);<br>    float4 grain = <span class="hljs-built_in">CalculateColorGrain</span>(luminance, distortedUV * SceneColorViewport_ViewportSize);<br><br>    <span class="hljs-type">float</span> vignette = <span class="hljs-built_in">CalculateVignette</span>(distortedUV);<br>    <span class="hljs-type">float</span> scanline = <span class="hljs-built_in">CalculateScanline</span>(sampleUV);<br>    float4 tvMaskColor = TVMaskTexture.<span class="hljs-built_in">SampleLevel</span>(GlobalBilinearClampedSampler, sampleUV, <span class="hljs-number">0</span>);<br><br>    Output[SceneColorViewport_ViewportMin + DispatchThreadId] = (distortedColor + grain) * tvMaskColor * vignette * scanline;<br>&#125;<br><br></code></pre></td></tr></table></figure>
暂且不讨论具体的着色器实现逻辑，可以注意到我们在着色器中定义了多种不同类型的全局变量，例如
<code>Texture2D</code>、<code>float</code> 以及
<code>RWTexture2D&lt;float4&gt;</code>。这些变量在 <strong>C++
侧有着各自不同的声明和绑定方式</strong>，需要分别进行处理。</p>
<p>除了自定义变量之外，我们还使用了一些 Unreal Engine
中已经预先声明好的内建变量。其中之一是<br />
<code>SCREEN_PASS_TEXTURE_VIEWPORT(SceneColorViewport)</code>，该宏能够为我们提供与当前视口尺寸相关的一系列参数，因此需要引入头文件
<code>ScreenPass.ush</code>。<br />
另一个常用的内建变量是
<code>View</code>，它包含了大量与视图相关的运行时数据，例如本文着色器中用到的
<code>View.RealTime</code>。</p>
<h3 id="创建自定义sceneviewextension">创建自定义SceneViewExtension</h3>
<h4 id="自定义sve类的.h文件声明">自定义SVE类的.h文件声明</h4>
<p>接下来就可以基于自定义着色器来编写对应的
<code>SceneViewExtension</code> 了。首先新建一个名为
<code>RetroTVSceneViewExtension</code> 的 C++ 类，并继承自
<code>FSceneViewExtensionBase</code>。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RETROTV_API</span> FRetroTVSceneViewExtension : <span class="hljs-keyword">public</span> FSceneViewExtensionBase<br>&#123;<br><span class="hljs-keyword">public</span>:<br>	<span class="hljs-built_in">FRetroTVSceneViewExtension</span>(<span class="hljs-type">const</span> FAutoRegister&amp; AutoRegister);<br><br><span class="hljs-keyword">public</span>:<br>	<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetTVMaskTexture</span><span class="hljs-params">(<span class="hljs-type">const</span> UTexture2D* InTexture)</span></span>;<br>	<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetScanLineTexture</span><span class="hljs-params">(<span class="hljs-type">const</span> UTexture2D* InTexture)</span></span>;<br><br>	<span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">SubscribeToPostProcessingPass</span><span class="hljs-params">(EPostProcessingPass PassId, <span class="hljs-type">const</span> FSceneView&amp; View, FAfterPassCallbackDelegateArray&amp; InOutPassCallbacks, <span class="hljs-type">bool</span> bIsPassEnabled)</span> <span class="hljs-keyword">override</span></span>;<br><br>	<span class="hljs-function">FScreenPassTexture <span class="hljs-title">CustomPostProcessing</span><span class="hljs-params">(FRDGBuilder&amp; GraphBuilder, <span class="hljs-type">const</span> FSceneView&amp; View, <span class="hljs-type">const</span> FPostProcessMaterialInputs&amp; Inputs)</span></span>;<br><br><br><span class="hljs-keyword">private</span>:<br>	FTextureRHIRef TVMaskTextureRHI;<br>	FTextureRHIRef ScanLineTextureRHI;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>在这个 SVE 类中，我们可以通过重写诸如<br />
<code>SetupViewFamily(FSceneViewFamily&amp; InViewFamily)</code>、<br />
<code>BeginRenderViewFamily(FSceneViewFamily&amp; InViewFamily)</code><br />
等函数来修改视口属性，或在渲染流程中注入自定义 Pass。</p>
<p>不过，由于本文实现的是一个<strong>后处理效果</strong>，并不需要介入更早的渲染阶段，因此只需重写<br />
<code>SubscribeToPostProcessingPass( EPostProcessingPass PassId, const FSceneView&amp; View, FAfterPassCallbackDelegateArray&amp; InOutPassCallbacks, bool bIsPassEnabled )</code><br />
这一函数即可。该函数的主要作用是将我们自定义的后处理流程（以函数的形式）注册为某个后处理阶段的回调，并在对应的渲染阶段自动被调用，也就是代码中的<code>CustomPostProcessing(FRDGBuilder&amp; GraphBuilder, const FSceneView&amp; View, const FPostProcessMaterialInputs&amp; Inputs)</code>。回调函数的参数有严格的要求，不可随意更改。</p>
<p>此外，着色器中还使用了两个 <strong>RDG
之外的外部纹理资源</strong>，因此需要分别创建两个资源句柄
<code>TVMaskTextureRHI</code> 和
<code>ScanLineTextureRHI</code>，并正确配置它们对应的 <code>Set</code>
方法。</p>
<h4 id="自定义sve的.cpp文件">自定义SVE的.cpp文件</h4>
<h5 id="注册并编译着色器">注册并编译着色器</h5>
<p>在<code>RetroTVSceneViewExtension.cpp</code>文件中，首先需要创建一个和<code>.usf</code>文件对应的计算着色器类，相关代码如下：
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RETROTV_API</span> FLenDistortionCS : <span class="hljs-keyword">public</span> FGlobalShader<br>&#123;<br><span class="hljs-keyword">public</span>:<br>	<span class="hljs-built_in">DECLARE_GLOBAL_SHADER</span>(FLenDistortionCS);<br>	<span class="hljs-built_in">SHADER_USE_PARAMETER_STRUCT</span>(FLenDistortionCS, FGlobalShader);<br><br>	<span class="hljs-built_in">BEGIN_SHADER_PARAMETER_STRUCT</span>(FParameters, )<br>		<span class="hljs-built_in">SHADER_PARAMETER_STRUCT</span>(FScreenPassTextureViewportParameters, SceneColorViewport)<br>		<span class="hljs-built_in">SHADER_PARAMETER_STRUCT_REF</span>(FViewUniformShaderParameters, View)<br>		<span class="hljs-built_in">SHADER_PARAMETER</span>(<span class="hljs-type">float</span>, RetroScaleFactor)<br>		<span class="hljs-built_in">SHADER_PARAMETER</span>(<span class="hljs-type">float</span>, LensDistortionK1)<br>		<span class="hljs-built_in">SHADER_PARAMETER</span>(<span class="hljs-type">float</span>, LensDistortionK2)<br>		<span class="hljs-built_in">SHADER_PARAMETER</span>(<span class="hljs-type">float</span>, VignetteStart)<br>		<span class="hljs-built_in">SHADER_PARAMETER</span>(<span class="hljs-type">float</span>, VignetteEnd)<br>		<span class="hljs-built_in">SHADER_PARAMETER</span>(<span class="hljs-type">float</span>, VignettePower)<br>		<span class="hljs-built_in">SHADER_PARAMETER</span>(<span class="hljs-type">float</span>, VignetteIntensity)<br>		<span class="hljs-built_in">SHADER_PARAMETER</span>(<span class="hljs-type">float</span>, ScanlineSpeed)<br>		<span class="hljs-built_in">SHADER_PARAMETER</span>(<span class="hljs-type">float</span>, ScanlineIntensity)<br>		<span class="hljs-built_in">SHADER_PARAMETER</span>(<span class="hljs-type">float</span>, ScanlineScale)<br>		<span class="hljs-built_in">SHADER_PARAMETER_RDG_TEXTURE</span>(Texture2D, OriginalSceneColor)<br>		<span class="hljs-built_in">SHADER_PARAMETER_TEXTURE</span>(Texture2D, TVMaskTexture)<br>		<span class="hljs-built_in">SHADER_PARAMETER_TEXTURE</span>(Texture2D, ScanLineTexture)<br>		<span class="hljs-built_in">SHADER_PARAMETER_RDG_TEXTURE_UAV</span>(RWTexture2D&lt;float4&gt;, Output)<br>	<span class="hljs-built_in">END_SHADER_PARAMETER_STRUCT</span>()<br><br>	<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">ShouldCompilePermutation</span><span class="hljs-params">(<span class="hljs-type">const</span> FGlobalShaderPermutationParameters&amp; Parameters)</span></span><br><span class="hljs-function">	</span>&#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-built_in">IsFeatureLevelSupported</span>(Parameters.Platform, ERHIFeatureLevel::SM5);<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">ModifyCompilationEnvironment</span><span class="hljs-params">(<span class="hljs-type">const</span> FGlobalShaderPermutationParameters&amp; Parameters, FShaderCompilerEnvironment&amp; OutEnvironment)</span></span><br><span class="hljs-function">	</span>&#123;<br>		OutEnvironment.<span class="hljs-built_in">SetDefine</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;THREADS_X&quot;</span>), <span class="hljs-number">8</span>);<br>		OutEnvironment.<span class="hljs-built_in">SetDefine</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;THREADS_Y&quot;</span>), <span class="hljs-number">8</span>);<br>		OutEnvironment.<span class="hljs-built_in">SetDefine</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;THREADS_Z&quot;</span>), <span class="hljs-number">1</span>);<br>	&#125;<br>&#125;;<br><br><span class="hljs-built_in">IMPLEMENT_GLOBAL_SHADER</span>(FLenDistortionCS, <span class="hljs-string">&quot;/Plugins/RetroTVShaders/LensDistortion.usf&quot;</span>, <span class="hljs-string">&quot;MainCS&quot;</span>, SF_Compute);<br></code></pre></td></tr></table></figure> 我们通过 <code>BEGIN_SHADER_PARAMETER_STRUCT()</code>
显式声明该着色器所使用的所有全局变量。只有在这里正确地定义并绑定这些参数，才能确保
C++ 侧的数据被正确传递到着色器中：</p>
<ol type="1">
<li><code>SHADER_PARAMETER</code>：用于声明基础类型参数，例如
<code>float</code>、<code>int</code>、<code>uint</code>
等常量数据；</li>
<li><code>SHADER_PARAMETER_RDG_TEXTURE</code>：用于声明 <strong>由 RDG
创建并管理的只读纹理资源</strong>，通常作为 Shader Resource
View（SRV）使用；</li>
<li><code>SHADER_PARAMETER_RDG_TEXTURE</code>：用于声明 <strong>位于 RDG
之外、由 RHI 管理的只读纹理资源</strong>，常用于外部导入的纹理（如
<code>UTexture2D</code>）；</li>
<li><code>SHADER-PARAMETER_RDG_TEXTURE_UAV</code>：用于声明 <strong>由
RDG 创建并管理的可读写纹理资源</strong>，通常作为 Compute Shader
的输出目标（UAV）；</li>
<li><code>SHADER_PARAMETER_STRUCT</code>：用于内嵌一个
<strong>值拷贝形式的参数结构体</strong>，例如视口参数、常量打包参数等；</li>
<li><code>SHADER_PARAMETER_STRUCT_REF</code>：用于引用一个
<strong>由引擎统一维护的参数结构体</strong>，常见的例子是
<code>View</code>、<code>SceneTextures</code> 等；</li>
</ol>
<p>最后，通过调用 <code>IMPLEMENT_GLOBAL_SHADER()</code>
将该着色器注册到 Unreal Engine
中，确保其在启动或编译阶段被正确编译，并能够被引擎正常识别和使用。</p>
<h5 id="声明控制台变量">声明控制台变量</h5>
<p>由于控制台变量本身具备良好的线程安全性，因此这里使用控制台变量来控制着色器中的相关参数。相关代码如下：
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">namespace</span><br>&#123;<br>	<span class="hljs-function">TAutoConsoleVariable&lt;int32&gt; <span class="hljs-title">CVarShaderOn</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">		TEXT(<span class="hljs-string">&quot;r.RetroTV&quot;</span>),</span></span><br><span class="hljs-params"><span class="hljs-function">		<span class="hljs-number">0</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">		TEXT(<span class="hljs-string">&quot;Enable RetroTV SceneViewExtension \n&quot;</span>)</span></span><br><span class="hljs-params"><span class="hljs-function">		TEXT(<span class="hljs-string">&quot; 0: OFF;&quot;</span>)</span></span><br><span class="hljs-params"><span class="hljs-function">		TEXT(<span class="hljs-string">&quot; 1: ON.&quot;</span>),</span></span><br><span class="hljs-params"><span class="hljs-function">		ECVF_RenderThreadSafe)</span></span>;<br>&#125;<br><br><span class="hljs-keyword">namespace</span><br>&#123;<br>	<span class="hljs-function">TAutoConsoleVariable&lt;<span class="hljs-type">float</span>&gt; <span class="hljs-title">CVarScaleFactor</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">		TEXT(<span class="hljs-string">&quot;r.RetroTV.ScaleFactor&quot;</span>),</span></span><br><span class="hljs-params"><span class="hljs-function">		<span class="hljs-number">1.0f</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">		TEXT(<span class="hljs-string">&quot;Update ScaleFactor \n&quot;</span>),</span></span><br><span class="hljs-params"><span class="hljs-function">		ECVF_RenderThreadSafe)</span></span>;<br>&#125;<br><br><br><span class="hljs-keyword">namespace</span><br>&#123;<br>	<span class="hljs-function">TAutoConsoleVariable&lt;<span class="hljs-type">float</span>&gt; <span class="hljs-title">CVarLenDistortionK1</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">		TEXT(<span class="hljs-string">&quot;r.RetroTV.LenDistortionK1&quot;</span>),</span></span><br><span class="hljs-params"><span class="hljs-function">		<span class="hljs-number">0.05f</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">		TEXT(<span class="hljs-string">&quot;Update LenDistortionK1 \n&quot;</span>),</span></span><br><span class="hljs-params"><span class="hljs-function">		ECVF_RenderThreadSafe)</span></span>;<br>&#125;<br><br><span class="hljs-keyword">namespace</span><br>&#123;<br>	<span class="hljs-function">TAutoConsoleVariable&lt;<span class="hljs-type">float</span>&gt; <span class="hljs-title">CVarLenDistortionK2</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">		TEXT(<span class="hljs-string">&quot;r.RetroTV.LenDistortionK2&quot;</span>),</span></span><br><span class="hljs-params"><span class="hljs-function">		<span class="hljs-number">0.02f</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">		TEXT(<span class="hljs-string">&quot;Update LenDistortionK2 \n&quot;</span>),</span></span><br><span class="hljs-params"><span class="hljs-function">		ECVF_RenderThreadSafe)</span></span>;<br>&#125;<br><br><span class="hljs-keyword">namespace</span><br>&#123;<br>	<span class="hljs-function">TAutoConsoleVariable&lt;<span class="hljs-type">float</span>&gt; <span class="hljs-title">CVarVignetteStart</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">		TEXT(<span class="hljs-string">&quot;r.RetroTV.VignetteStart&quot;</span>),</span></span><br><span class="hljs-params"><span class="hljs-function">		<span class="hljs-number">0.7f</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">		TEXT(<span class="hljs-string">&quot;Update VignetteStart \n&quot;</span>),</span></span><br><span class="hljs-params"><span class="hljs-function">		ECVF_RenderThreadSafe)</span></span>;<br>&#125;<br><br><span class="hljs-keyword">namespace</span><br>&#123;<br>	<span class="hljs-function">TAutoConsoleVariable&lt;<span class="hljs-type">float</span>&gt; <span class="hljs-title">CVarVignetteEnd</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">		TEXT(<span class="hljs-string">&quot;r.RetroTV.VignetteEnd&quot;</span>),</span></span><br><span class="hljs-params"><span class="hljs-function">		<span class="hljs-number">1.0f</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">		TEXT(<span class="hljs-string">&quot;Update VignetteEnd \n&quot;</span>),</span></span><br><span class="hljs-params"><span class="hljs-function">		ECVF_RenderThreadSafe)</span></span>;<br>&#125;<br><br><span class="hljs-keyword">namespace</span><br>&#123;<br>	<span class="hljs-function">TAutoConsoleVariable&lt;<span class="hljs-type">float</span>&gt; <span class="hljs-title">CVarVignettePower</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">		TEXT(<span class="hljs-string">&quot;r.RetroTV.VignettePower&quot;</span>),</span></span><br><span class="hljs-params"><span class="hljs-function">		<span class="hljs-number">2.0f</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">		TEXT(<span class="hljs-string">&quot;Update VignettePower \n&quot;</span>),</span></span><br><span class="hljs-params"><span class="hljs-function">		ECVF_RenderThreadSafe)</span></span>;<br>&#125;<br><br><span class="hljs-keyword">namespace</span><br>&#123;<br>	<span class="hljs-function">TAutoConsoleVariable&lt;<span class="hljs-type">float</span>&gt; <span class="hljs-title">CVarVignetteIntensity</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">		TEXT(<span class="hljs-string">&quot;r.RetroTV.VignetteIntensity&quot;</span>),</span></span><br><span class="hljs-params"><span class="hljs-function">		<span class="hljs-number">0.7f</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">		TEXT(<span class="hljs-string">&quot;Update VignetteIntensity \n&quot;</span>),</span></span><br><span class="hljs-params"><span class="hljs-function">		ECVF_RenderThreadSafe)</span></span>;<br>&#125;<br><br><span class="hljs-keyword">namespace</span><br>&#123;<br>	<span class="hljs-function">TAutoConsoleVariable&lt;<span class="hljs-type">float</span>&gt; <span class="hljs-title">CVarScanlineSpeed</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">		TEXT(<span class="hljs-string">&quot;r.RetroTV.ScanlineSpeed&quot;</span>),</span></span><br><span class="hljs-params"><span class="hljs-function">		<span class="hljs-number">0.2f</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">		TEXT(<span class="hljs-string">&quot;Update ScanlineSpeed \n&quot;</span>),</span></span><br><span class="hljs-params"><span class="hljs-function">		ECVF_RenderThreadSafe)</span></span>;<br>&#125;<br><br><span class="hljs-keyword">namespace</span><br>&#123;<br>	<span class="hljs-function">TAutoConsoleVariable&lt;<span class="hljs-type">float</span>&gt; <span class="hljs-title">CVarScanlineIntensity</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">		TEXT(<span class="hljs-string">&quot;r.RetroTV.ScanlineIntensity&quot;</span>),</span></span><br><span class="hljs-params"><span class="hljs-function">		<span class="hljs-number">0.7f</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">		TEXT(<span class="hljs-string">&quot;Update ScanlineIntensity \n&quot;</span>),</span></span><br><span class="hljs-params"><span class="hljs-function">		ECVF_RenderThreadSafe)</span></span>;<br>&#125;<br><br><span class="hljs-keyword">namespace</span><br>&#123;<br>	<span class="hljs-function">TAutoConsoleVariable&lt;<span class="hljs-type">float</span>&gt; <span class="hljs-title">CVarScanlineScale</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">		TEXT(<span class="hljs-string">&quot;r.RetroTV.ScanlineScale&quot;</span>),</span></span><br><span class="hljs-params"><span class="hljs-function">		<span class="hljs-number">5.0f</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">		TEXT(<span class="hljs-string">&quot;Update ScanlineScale \n&quot;</span>),</span></span><br><span class="hljs-params"><span class="hljs-function">		ECVF_RenderThreadSafe)</span></span>;<br>&#125;<br><br></code></pre></td></tr></table></figure></p>
<h5 id="设置纹理资源">设置纹理资源</h5>
<p>我们还需要设置两个外部纹理资源（由 RHI
维护的纹理资源），相关代码如下： <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FRetroTVSceneViewExtension::SetTVMaskTexture</span><span class="hljs-params">(<span class="hljs-type">const</span> UTexture2D* InTexture)</span></span><br><span class="hljs-function"></span>&#123;<br>	FTextureRHIRef NewRHI = <span class="hljs-literal">nullptr</span>;<br><br>	<span class="hljs-keyword">if</span> (InTexture &amp;&amp; InTexture-&gt;<span class="hljs-built_in">GetResource</span>())<br>	&#123;<br>		NewRHI = InTexture-&gt;<span class="hljs-built_in">GetResource</span>()-&gt;TextureRHI;<br>	&#125;<br><br>	<span class="hljs-built_in">ENQUEUE_RENDER_COMMAND</span>(RetroTV_SetExtraTexture)<br>		(<br>			[<span class="hljs-keyword">this</span>, NewRHI](FRHICommandListImmediate&amp; RHICmdList)<br>			&#123;<br>				TVMaskTextureRHI = NewRHI;<br>			&#125;);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FRetroTVSceneViewExtension::SetScanLineTexture</span><span class="hljs-params">(<span class="hljs-type">const</span> UTexture2D* InTexture)</span></span><br><span class="hljs-function"></span>&#123;<br>	FTextureRHIRef NewRHI = <span class="hljs-literal">nullptr</span>;<br><br>	<span class="hljs-keyword">if</span> (InTexture &amp;&amp; InTexture-&gt;<span class="hljs-built_in">GetResource</span>())<br>	&#123;<br>		NewRHI = InTexture-&gt;<span class="hljs-built_in">GetResource</span>()-&gt;TextureRHI;<br>	&#125;<br><br>	<span class="hljs-built_in">ENQUEUE_RENDER_COMMAND</span>(RetroTV_SetExtraTexture)<br>		(<br>			[<span class="hljs-keyword">this</span>, NewRHI](FRHICommandListImmediate&amp; RHICmdList)<br>			&#123;<br>				ScanLineTextureRHI = NewRHI;<br>			&#125;);<br>&#125;<br></code></pre></td></tr></table></figure>
由于输入纹理最初位于<strong>游戏线程</strong>，而渲染相关资源只能在<strong>渲染线程</strong>上安全访问，因此需要借助
<code>ENQUEUE_RENDER_COMMAND</code>
将这些资源的引用安全地传递到渲染线程中进行处理。</p>
<h5 id="注册回调函数">注册回调函数</h5>
<p>Unreal Engine
的后处理流程被划分为多个不同的阶段，具体的阶段名称可以在
<code>EPostProcessingPass</code>
枚举中查阅。一般情况下，将自定义后处理插入到 <strong>MotionBlur</strong>
阶段即可满足需求。<br />
我在实际测试中，将 Pass
插入到其他阶段时，往往会遇到诸如黑屏等问题，因此这里选择使用相对稳定的
MotionBlur 阶段。 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FRetroTVSceneViewExtension::SubscribeToPostProcessingPass</span><span class="hljs-params">(EPostProcessingPass PassId, <span class="hljs-type">const</span> FSceneView&amp; View,</span></span><br><span class="hljs-params"><span class="hljs-function">	FAfterPassCallbackDelegateArray&amp; InOutPassCallbacks, <span class="hljs-type">bool</span> bIsPassEnabled)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span> (PassId == EPostProcessingPass::MotionBlur)<br>	&#123;<br>		InOutPassCallbacks.<span class="hljs-built_in">Add</span>(FAfterPassCallbackDelegate::<span class="hljs-built_in">CreateRaw</span>(<span class="hljs-keyword">this</span>, &amp;FRetroTVSceneViewExtension::CustomPostProcessing));<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure></p>
<h5 id="编写自定义的pass">编写自定义的Pass</h5>
<p>这一步的实现也相对简单，只需要将前面准备好的参数传递给着色器即可。由于使用的是计算管线，不需要配置图形管线中诸如顶点布局、渲染状态等相关参数，因此整体流程显得更加简洁明了。代码如下：
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">FScreenPassTexture <span class="hljs-title">FRetroTVSceneViewExtension::CustomPostProcessing</span><span class="hljs-params">(FRDGBuilder&amp; GraphBuilder, <span class="hljs-type">const</span> FSceneView&amp; SceneView,</span></span><br><span class="hljs-params"><span class="hljs-function">	<span class="hljs-type">const</span> FPostProcessMaterialInputs&amp; Inputs)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">const</span> FSceneViewFamily&amp; ViewFamily = *SceneView.Family;<br><br>	<span class="hljs-type">const</span> FScreenPassTexture&amp; SceneColor = FScreenPassTexture::<span class="hljs-built_in">CopyFromSlice</span>(GraphBuilder, Inputs.<span class="hljs-built_in">GetInput</span>(EPostProcessMaterialInput::SceneColor));<br><br>	<span class="hljs-keyword">if</span> (!SceneColor.<span class="hljs-built_in">IsValid</span>() || CVarShaderOn.<span class="hljs-built_in">GetValueOnRenderThread</span>() == <span class="hljs-number">0</span>)<br>	&#123;<br>		<span class="hljs-keyword">return</span> SceneColor;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-type">const</span> FScreenPassTextureViewport <span class="hljs-title">SceneColorViewport</span><span class="hljs-params">(SceneColor)</span></span>;<br><br>	<span class="hljs-built_in">RDG_EVENT_SCOPE</span>(GraphBuilder, <span class="hljs-string">&quot;RetroTV Postprocess Effect&quot;</span>);<br>	&#123;<br>		FGlobalShaderMap* GlobalShaderMap = <span class="hljs-built_in">GetGlobalShaderMap</span>(ViewFamily.<span class="hljs-built_in">GetFeatureLevel</span>());<br>		<span class="hljs-function">TShaderMapRef&lt;FLenDistortionCS&gt; <span class="hljs-title">ComputeShader</span><span class="hljs-params">(GlobalShaderMap)</span></span>;<br><br>		FRDGTextureDesc OutputDesc;<br>		&#123;<br>			OutputDesc = SceneColor.Texture-&gt;Desc;<br>			<span class="hljs-comment">// OutputDesc.Reset();</span><br>			OutputDesc.Flags |= TexCreate_UAV;<br>			OutputDesc.Flags &amp;= ~(TexCreate_RenderTargetable | TexCreate_FastVRAM);<br><br>			<span class="hljs-function">FLinearColor <span class="hljs-title">ClearColor</span><span class="hljs-params">(<span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">0.</span>)</span></span>;<br>			OutputDesc.ClearValue = <span class="hljs-built_in">FClearValueBinding</span>(ClearColor);<br>		&#125;<br><br>		FRDGTextureRef OutputTexture = GraphBuilder.<span class="hljs-built_in">CreateTexture</span>(OutputDesc, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;LenDistortion Effect Output Texture&quot;</span>));<br><br>		FLenDistortionCS::FParameters* PassParameters = GraphBuilder.<span class="hljs-built_in">AllocParameters</span>&lt;FLenDistortionCS::FParameters&gt;();<br><br>		FIntPoint PassViewSize = SceneColor.ViewRect.<span class="hljs-built_in">Size</span>();<br><br>		PassParameters-&gt;View = SceneView.ViewUniformBuffer;<br>		PassParameters-&gt;RetroScaleFactor = CVarScaleFactor.<span class="hljs-built_in">GetValueOnRenderThread</span>();<br>		PassParameters-&gt;LensDistortionK1 = CVarLenDistortionK<span class="hljs-number">1.</span><span class="hljs-built_in">GetValueOnRenderThread</span>();<br>		PassParameters-&gt;LensDistortionK2 = CVarLenDistortionK<span class="hljs-number">2.</span><span class="hljs-built_in">GetValueOnRenderThread</span>();<br>		PassParameters-&gt;VignetteStart = CVarVignetteStart.<span class="hljs-built_in">GetValueOnRenderThread</span>();<br>		PassParameters-&gt;VignetteEnd = CVarVignetteEnd.<span class="hljs-built_in">GetValueOnRenderThread</span>();<br>		PassParameters-&gt;VignettePower = CVarVignettePower.<span class="hljs-built_in">GetValueOnRenderThread</span>();<br>		PassParameters-&gt;VignetteIntensity = CVarVignetteIntensity.<span class="hljs-built_in">GetValueOnRenderThread</span>();<br>		PassParameters-&gt;ScanlineScale = CVarScanlineScale.<span class="hljs-built_in">GetValueOnRenderThread</span>();<br>		PassParameters-&gt;ScanlineSpeed = CVarScanlineSpeed.<span class="hljs-built_in">GetValueOnRenderThread</span>();<br>		PassParameters-&gt;ScanlineIntensity = CVarScanlineIntensity.<span class="hljs-built_in">GetValueOnRenderThread</span>();<br>		PassParameters-&gt;OriginalSceneColor = SceneColor.Texture;<br>		PassParameters-&gt;TVMaskTexture = TVMaskTextureRHI.<span class="hljs-built_in">IsValid</span>() ? TVMaskTextureRHI : GWhiteTexture-&gt;TextureRHI;<br>		PassParameters-&gt;ScanLineTexture = ScanLineTextureRHI.<span class="hljs-built_in">IsValid</span>()? ScanLineTextureRHI : GWhiteTexture-&gt;TextureRHI;<br>		PassParameters-&gt;SceneColorViewport = <span class="hljs-built_in">GetScreenPassTextureViewportParameters</span>(SceneColorViewport);<br>		PassParameters-&gt;Output = GraphBuilder.<span class="hljs-built_in">CreateUAV</span>(<span class="hljs-built_in">FRDGTextureUAVDesc</span>(OutputTexture));<br><br>		FIntVector GroupCount = FComputeShaderUtils::<span class="hljs-built_in">GetGroupCount</span>(PassViewSize, FComputeShaderUtils::kGolden2DGroupSize);<br><br>		FComputeShaderUtils::<span class="hljs-built_in">AddPass</span>(<br>			GraphBuilder,<br>			<span class="hljs-built_in">RDG_EVENT_NAME</span>(<span class="hljs-string">&quot;LenDistorted Post Processing CS Shader %dx%d&quot;</span>, PassViewSize.X, PassViewSize.Y),<br>			ComputeShader,<br>			PassParameters,<br>			GroupCount<br>		);<br><br>		<span class="hljs-keyword">return</span> <span class="hljs-built_in">FScreenPassTexture</span>(OutputTexture, SceneColor.ViewRect);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
值得一提的是，我们需要额外创建一张<strong>用于写入的输出纹理</strong>，而不能直接对输入的
<code>SceneColor</code> 进行 UAV 写入。最方便的做法是以
<code>SceneColor.Texture-&gt;Desc</code>
为基础复制一份描述信息，保证分辨率、格式等属性一致；随后再对其做少量修改：为其添加
<code>TexCreate_UAV</code> 标志，使其可被 Compute Shader 写入，同时移除
<code>TexCreate_RenderTargetable</code> 和
<code>TexCreate_FastVRAM</code>
等与当前使用场景不匹配的标志，并设置合适的清除色。</p>
<p>最后返回这个新建的输出纹理即可，它会由RDG自动管理。</p>
<h3
id="用developersettings获取外部纹理">用DeveloperSettings获取外部纹理</h3>
<p>至此，我们已经创建了一个自定义的
<code>SceneViewExtension</code>。但由于 <code>SceneViewExtension</code>
并不是 <code>UObject</code> 的子类，无法在 Unreal Editor
中直接创建蓝图或暴露可编辑属性，那么该如何将
<strong>编辑器中配置的纹理资源</strong> 传递给这个 SVE 呢？</p>
<p>一个相对简单且常用的解决方案是借助 <code>DeveloperSettings</code>
类来维护这些全局资源。通过这种方式，我们可以在 <strong>项目设置（Project
Settings）</strong> 的对应页面中直接指定所需的纹理或参数，而
<code>SceneViewExtension</code> 则在运行时读取这些配置并加以使用。</p>
<p>因此，新建一个C++类，父类选择<code>DeveloperSettings</code>，并在类中声明两个<code>UTexture2D</code>变量：
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UTexture2D</span>;<br><br><span class="hljs-built_in">UCLASS</span>(Config = RetroTV, DefaultConfig, meta=(DisplayName=<span class="hljs-string">&quot;RetroTV&quot;</span>))<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RETROTV_API</span> URetroTVSettings : <span class="hljs-keyword">public</span> UDeveloperSettings<br>&#123;<br>	<span class="hljs-built_in">GENERATED_BODY</span>()<br><br><span class="hljs-keyword">public</span>:<br>	<span class="hljs-built_in">UPROPERTY</span>(EditAnywhere, Config, Category = <span class="hljs-string">&quot;Textures&quot;</span>)<br>	TSoftObjectPtr&lt;UTexture2D&gt; TVMaskTexture;<br><br>	<span class="hljs-built_in">UPROPERTY</span>(EditAnywhere, Config, Category = <span class="hljs-string">&quot;Textures&quot;</span>)<br>	TSoftObjectPtr&lt;UTexture2D&gt; ScanLineTexture;<br><br>	<span class="hljs-built_in">URetroTVSettings</span>() = <span class="hljs-keyword">default</span>;<br>&#125;;<br><br></code></pre></td></tr></table></figure>
现在打开UE的项目设置，找到RetroTV标签，打开之后就能指定资源了。
<img src="/2026/Unreal/RDG%E6%B8%B2%E6%9F%93%E4%BE%9D%E8%B5%96%E5%9B%BE/03-%E7%94%A8SceneViewExtension%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E5%90%8E%E5%A4%84%E7%90%86%E6%95%88%E6%9E%9C/IMG-20260131211529221.png" srcset="/img/loading.gif" lazyload class=""></p>
<h3 id="实例化自定义sve类">实例化自定义SVE类</h3>
<p>在<code>Subsystem</code>中实例化SVE类是比较推荐的做法。因此新建一个C++类，命名为<code>RetroTVSubsystem</code>，父类选择<code>UGameInstanceSubsystem</code>。
它需要维护一个SVE类，并在这个子系统初始化的时候，用<code>UTexture2D</code>初始化SVE类中纹理资源。相关代码如下：
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">UCLASS</span>()<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RETROTV_API</span> URetroTVSubsystem : <span class="hljs-keyword">public</span> UGameInstanceSubsystem<br>&#123;<br>	<span class="hljs-built_in">GENERATED_BODY</span>()<br><br><span class="hljs-keyword">public</span>:<br><br>	<span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">Initialize</span><span class="hljs-params">(FSubsystemCollectionBase&amp; Collection)</span> <span class="hljs-keyword">override</span></span>;<br>	<span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">Deinitialize</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span></span>;<br><br><span class="hljs-keyword">private</span>:<br>	TSharedPtr&lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">FRetroTVSceneViewExtension</span>, ESPMode::ThreadSafe&gt; CustomSceneViewExtension;<br><br>&#125;;<br></code></pre></td></tr></table></figure></p>
<p>对应函数实现如下： <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// Fill out your copyright notice in the Description page of Project Settings.</span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;RetroTVSubsystem.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;RetroTVSettings.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;RetroTVSceneViewExtension.h&quot;</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">URetroTVSubsystem::Initialize</span><span class="hljs-params">(FSubsystemCollectionBase&amp; Collection)</span></span><br><span class="hljs-function"></span>&#123;<br>	CustomSceneViewExtension = FSceneViewExtensions::<span class="hljs-built_in">NewExtension</span>&lt;FRetroTVSceneViewExtension&gt;();<br>	<span class="hljs-built_in">UE_LOG</span>(LogTemp, Log, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;SceneViewExtensionTemplate: Subsystem initialized &amp; SceneViewExtension created&quot;</span>));<br><br>	<span class="hljs-type">const</span> URetroTVSettings* Settings = <span class="hljs-built_in">GetDefault</span>&lt;URetroTVSettings&gt;();<br>	UTexture2D* TVMaskTexturePtr = Settings ? Settings-&gt;TVMaskTexture.<span class="hljs-built_in">LoadSynchronous</span>() : <span class="hljs-literal">nullptr</span>;<br>	UTexture2D* ScanLineTexturePtr = Settings ? Settings-&gt;ScanLineTexture.<span class="hljs-built_in">LoadSynchronous</span>() : <span class="hljs-literal">nullptr</span>;<br><br>	<span class="hljs-keyword">if</span> (!TVMaskTexturePtr)<br>	&#123;<br>		<span class="hljs-built_in">UE_LOG</span>(LogTemp, Warning, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;RetroTV: TVMaskTexture not set or failed to load. (Project Settings -&gt; RetroTV)&quot;</span>));<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (!ScanLineTexturePtr)<br>	&#123;<br>		<span class="hljs-built_in">UE_LOG</span>(LogTemp, Warning, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;RetroTV: ScanLineTexture not set or failed to load. (Project Settings -&gt; RetroTV)&quot;</span>));<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	CustomSceneViewExtension-&gt;<span class="hljs-built_in">SetTVMaskTexture</span>(TVMaskTexturePtr);<br>	<span class="hljs-built_in">UE_LOG</span>(LogTemp, Log, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;RetroTV: TVMaskTexture set to %s&quot;</span>), *TVMaskTexturePtr-&gt;<span class="hljs-built_in">GetName</span>());<br><br>	CustomSceneViewExtension-&gt;<span class="hljs-built_in">SetScanLineTexture</span>(ScanLineTexturePtr);<br>	<span class="hljs-built_in">UE_LOG</span>(LogTemp, Log, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;RetroTV: ScanLineTexture set to %s&quot;</span>), *ScanLineTexturePtr-&gt;<span class="hljs-built_in">GetName</span>());<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">URetroTVSubsystem::Deinitialize</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	&#123;<br>		CustomSceneViewExtension-&gt;IsActiveThisFrameFunctions.<span class="hljs-built_in">Empty</span>();<br><br>		FSceneViewExtensionIsActiveFunctor IsActiveFunctor;<br><br>		IsActiveFunctor.IsActiveFunction = [](<span class="hljs-type">const</span> ISceneViewExtension* SceneViewExtension, <span class="hljs-type">const</span> FSceneViewExtensionContext&amp; Context)<br>			&#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-built_in">TOptional</span>&lt;<span class="hljs-type">bool</span>&gt;(<span class="hljs-literal">false</span>);<br>			&#125;;<br><br>		CustomSceneViewExtension-&gt;IsActiveThisFrameFunctions.<span class="hljs-built_in">Add</span>(IsActiveFunctor);<br>	&#125;<br><br>	CustomSceneViewExtension.<span class="hljs-built_in">Reset</span>();<br>	CustomSceneViewExtension = <span class="hljs-literal">nullptr</span>;<br>&#125;<br></code></pre></td></tr></table></figure> 至此所有代码编辑完成。</p>
<h3 id="最终效果">最终效果</h3>
<p>点击模拟（第一次模拟可能会出现问题，大概率是因为资源还没有完全加载完毕），在控制台输入<code>r.RetroTV 1</code>即可启用这个后处理效果：
<img src="/2026/Unreal/RDG%E6%B8%B2%E6%9F%93%E4%BE%9D%E8%B5%96%E5%9B%BE/03-%E7%94%A8SceneViewExtension%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E5%90%8E%E5%A4%84%E7%90%86%E6%95%88%E6%9E%9C/IMG-20260131212439161.png" srcset="/img/loading.gif" lazyload class=""></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E8%99%9A%E5%B9%BB%E5%BC%95%E6%93%8E/" class="category-chain-item">虚幻引擎</a>
  
  
    <span>></span>
    
  <a href="/categories/%E8%99%9A%E5%B9%BB%E5%BC%95%E6%93%8E/%E6%B8%B2%E6%9F%93%E4%BE%9D%E8%B5%96%E5%9B%BE/" class="category-chain-item">渲染依赖图</a>
  
  
    <span>></span>
    
  <a href="/categories/%E8%99%9A%E5%B9%BB%E5%BC%95%E6%93%8E/%E6%B8%B2%E6%9F%93%E4%BE%9D%E8%B5%96%E5%9B%BE/SceneViewExtension/" class="category-chain-item">SceneViewExtension</a>
  
  

  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E8%99%9A%E5%B9%BB%E5%BC%95%E6%93%8E/" class="print-no-link">#虚幻引擎</a>
      
        <a href="/tags/%E6%B8%B2%E6%9F%93%E4%BE%9D%E8%B5%96%E5%9B%BE/" class="print-no-link">#渲染依赖图</a>
      
        <a href="/tags/RDG/" class="print-no-link">#RDG</a>
      
        <a href="/tags/SceneViewExtension/" class="print-no-link">#SceneViewExtension</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>虚幻引擎用SceneViewExtension实现简单后处理效果</div>
      <div>https://onikatahoshio.github.io/2026/Unreal/RDG渲染依赖图/03-用SceneViewExtension实现简单后处理效果/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>OnikataHoshio</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2026年1月31日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2026/%E9%A3%8E%E6%A0%BC%E5%8C%96%E6%B8%B2%E6%9F%93/%E7%82%B9%E6%9F%93/04-%E5%9F%BA%E4%BA%8ESPH%E7%9A%84%E7%B2%92%E5%AD%90%E8%BF%AD%E4%BB%A3/" title="流动的点描：基于 WCSPH 流体动力学的图像风格化实践">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">流动的点描：基于 WCSPH 流体动力学的图像风格化实践</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2026/Unreal/RDG%E6%B8%B2%E6%9F%93%E4%BE%9D%E8%B5%96%E5%9B%BE/02-RDG%20%E5%9B%BE%E5%BD%A2%E7%AE%A1%E7%BA%BF%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B/" title="虚幻引擎RDG图形管线调用流程">
                        <span class="hidden-mobile">虚幻引擎RDG图形管线调用流程</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
